# 5장. 도커 허브 등 레지스트리에 이미지 공유하기

이번장에서는 도커 허브에 내가 만든 이미지를 올리고 여러 태그를 달아서 버전을 관리하는 방법을 배웠음.

### 레지스트리, 리포지토리, 이미지 태그 다루기

우선 레지스트리는 도커 이미지가 저장되는 깃헙 저장소 같은 곳이라고 생각하면 됨 (실제로는 이미지 레이어가 올라가는거긴함). 그리고 리포지토리는 깃헙에 있는 레포처럼 프로젝트별로 구분지을 수 있는 레포임. 그래서 원래 도커 이미지의 풀 네임은 다음과 같음

```docker
# [레지스트리]/[이미지 작성자의 계정이름]/[레포이름]:[버전]
docker.io/hj/practice_docker:latest
```

기본 레지스트리는 docker Hub이고, 태그는 latest임. 만약에 도커허브 말고 회사 전용 레지스트리나 개인 레지스트리에 보낼거면 이미지 만들때 위와 같은 형식으로 이름지어줘야함.

```docker
docker image tag [소스 이미지] [타겟 이미지]
```

docker image build 로 새로운 이미지를 만들지 않더라도 기존의 이미지를 새롭게 태그 달아서 만들어 줄 수 있음.

### 도커허브에 직접 빌드한 이미지 푸시하기

```docker
#1. 도커에 로그인하기
# 나같은 경우는 환경변수에 dockerID를 미리 저장해두었음
# 그게 아니라면 도커허브 아이디를 적어주면 됨
docker login --username $dockerID

#2. 푸시하기
docker image push [options] [이미지이름]
```

레지스트리도 도커 엔진이랑 같은 식으로 이미지 레이어를 다루기때문에 역시나 Dockerfile을 최대한 최적화해서 작성하는게 아주 중요함!

### 나만의 도커 레지스트리 운영하기

사실 나는 그냥 도커허브 쓸거같긴 한데 상황에 따라서 개인 도커 레지스트리를 가지고 있으면 좋은 상황이 있음.
예를 들면 도커 허브 사이트가 다운되었다든지 등등..
그래서 여기서는 직접 로컬에 레지스트리 올리고 거기에 이미지 올려보는 연습을 할거임. 이렇게 하면 좋은게 같은 로컬 네트워크에 있는 팀원들끼리 레지스트리 쉽게 공유할 수 있음.

```docker
# 1. 일단 레지스트리 이미지를 로컬에서 돌려줘야함
# --restart 옵션은 도커가 켜질때마다 항상 다시 해당 컨테이너를 시작한다는 옵션임
docker container run -d -p 5000:5000 --restart always diamol/registry

#2. 부르기 쉽게 로컬 hosts파일에 맵핑 추가해주기
# mac의 경우엔 /etc/hosts에 해당내용 추가
127.0.0.1 registry.local

#3. docker insecure registries에 위에 등록한 주소 추가해주기
# 왜냐면 기본적으로 도커 레지스트리는 https로 작동하는데 로컬에서 돌리는건 http임
# 위험하긴한데 로컬에서 간단히 맛만 보니까 상관없음

#4.이미지 푸시하기
docker image push registry.local:5000/[이미지이름]
```

### 이미지 태그를 효율적으로 사용하기

이부분은 이미지에 태그 달아서 버전관리 하는 방법과 관련된 부분임. 보통 흔히 많이 사용하는
[major].[minor].[patch] 형식으로 적어주는 거임.

- patch → 수정 내용은 버그 수정뿐이고 기능은 지난버전과 같을때
- minor → 추가 기능이 있지만, 기존 기능은 모두 유지할때
- major → 완전히 다른 기능을 가질때

그리고 이렇게 버전태그를 붙이면 좋은게 예를 들어서 매달 정기 배포를 하고 그 사이에 뭐가 있을때마다 배포를 한다고 생각해보자. latest로 하면 그 순간에 제일 최신거 이미지를 가져오게됨. :2로 태그를 붙여서 이미지를 가져오면 2.~.~ 중에 제일 최신거를 받아옴. :2.1로 붙여서 받아오면 2.1.~ 중에 제일 최신거를 받아옴. 이런식으로 편하게 버전관리를 할수 있음. 그리고 딱 특정 버전으로 받아야한다면 2.1.4 콕 집어주면 됨

### 공식 이미지에서 골든 이미지로 전환하기

도커허브 레지스트리에 있는 모든 이미지를 다 신뢰할 수 있는건 아님. 그래서 신뢰할 수 있는 대상이 올린거만 사용해야하는데 이를 방지하기위해 도커에서는 verified publisher, official image라는 제도를 도입했음.

쉽게 말해서 verified publisher는 검증된 퍼블리셔라 믿고 쓰면 된다는거고 공식 이미지는 검증된 이미지라는 개념임.

그래서 골든 이미지가 뭐냐면 공식 이미지를 받아서 사용하다가 내 입맛에 맞게 조금 수정해서 쓰는 이미지를 말함. 이걸 잘 써먹으면 아주 좋음

### 연습 문제

이번 연습문제는 로컬 레지스트리에 명령 한번으로 특정 이미지의 모든 태그 버전을 다 올리고, 다시 API호출을 통해 삭제하는 방법을 배웠음. 일단 레지스트리에 접속하는 방법은 API를 통한 방법밖에 없어서 관련해서 API찾아서 사용해주면 됨. manifest 호출해가지고 digest값 받아와서 삭제할때 썼던거 같음

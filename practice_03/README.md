# 3강. 도커 이미지 만들기

이전 장에서는 도커 허브에 올라가 있는 이미지를 가져와서 컨테이너를 실행하는 방법을 배웠음. 이번 시간에는
직접 Dockerfile 을 작성하고 이를 활용해 이미지를 만드는 법을 배워볼거임. 거기에 도커 이미지와 관련된 중요한 개념인 이미지 레이어도 함께 다뤄볼거임.

일단 이미지를 만드는 여러 방법이 있는데 자동화해서 쉽게 사용할 수 있는 방법중 하나가 Dockerfile을 활용하는 거임. 도커파일 전용 instruction 들도 있고, 일반 쉘이랑 똑같이 사용할 수 있는 명령들도 있음. 주로 사용되는건 아래의 5가지 정도임

```docker
# 기본적인 Dockerfile 작성법
# 아래에서 좀 더 개선하는 방법을 배울거임

# 도커 이미지는 무조건 다른 이미지를 기반으로 만들어짐
# 그렇기 때문에 기반이 될 다른 이미지를 지정해줘야함.
FROM diamol/node

# 도커 컨테이너가 만들어질때 기본적으로 도커 이미지에 심어진 환경변수값을 가져감
# 키="값"의 형식으로 지정해주면됨
ENV TARGET="www.naver.com"
ENV [key]="[value]"

# 실행될 컨테이너의 파일 시스템안에 web-ping이라는 디렉토리를 만들어주고
# 그걸 작업 디렉토리로 지정해주는 명령임. pwd의 기본이 /web-ping이 되는거임
WORKDIR /web-ping

# 호스트 -> 컨테이너로 파일을 복사해주는 명령임
# 로컬 호스트이 현재 디렉토리내의 app.js란 파일을 컨테이너의 .(현재 디렉토리, web-ping)에
# 넣어주는 작업임.
COPY app.js .
COPY [원본경로] [복사경로]

# 이미지로부터 컨테이너를 생성했을때 실행할 명령어를 지정해줄 수 있음.
CMD ["node", "/web-ping/app.js"]
```

```docker
# 이미지만 가져오는 방법
docker image pull [이미지 이름]

# 컨테이너를 실행할때 환경변수를 바꿔주는 방법
# -e 옵션을 사용해서 환경변수를 수정해줄 수 있음.
# --name 옵션을 사용해서 컨테이너에 이름을 지어줄 수 있음.
# 복잡하게 conatinerID를 활용하지 않고 이름을 사용할 수 있어서 간편
docker run -e TARGET="www.daum.net" --name practice web-ping

# 도커 이미지 빌드하는 방법
# 기본적으로 같은 디렉토리에 있는 Dockerfile이 사용됨
# 특정한 Dockerfile을 지정해주고 싶다면 -f 명령어로 지정해주면 됨
# -t, --tag 옵션으로 태그를 달아줄 수 있음.
# 그리고 도커 이미지를 빌드할때는 현재 디렉토리가 중요한데 그걸 컨텍스트라고 부름
# .을 통해서 컨텍스트 정보를 넘겨준 것을 확인할 수 있음
docker image build -t [tag 이름] .
```

docker image build 명령을 활용해서 이미지를 빌드해보면 Dockerfile에 사용된 각 instruction 한줄 한줄마다 뭔가 실행되는걸 확인할 수 있음. 도커 이미지를 받아올때도 파일 하나를 받는게 아니라 여러개가 받아지는 걸 볼 수 있음. 즉 도커 이미지는 하나의 단일 파일이 아니고 이미지 레이어라 불리는 파일들이 모여서 만들어진 논리적으로 하나의 파일임. 인스트럭션과 이미지 레이어는 1대1로 대응함. 이미지 레이어 개념이 아주 중요한데 그 이유는 서로 다른 이미지가 같은 이미지 레이어를 공유할 수 있기 때문임. 마치 운영체제 가상 메모리 개념에서 서로 다른 프로세스가 라이브러리 코드를 공유하는 것과 비슷한 개념이라고 생각하면 됨. 그래서 docker image ls 명령어로 확인해보면 각 이미지가 사이즈를 차지하는거 같은데 실제로 이미지 레이어를 공유하는 이미지들끼리는 훨씬 적은 사이즈를 차지함. 이건 docker system df 명령어를 통해 확인해보면 알 수 있음.

암튼 도커는 이미지 레이어를 도커 엔진의 캐시에다가 저장해둠. 이미 있는 이미지 레이어라면 굳이 새로 만들 필요가 없는거지. 그래서 docker image build 명령을 다시 실행해보면 cached 라고 캐시된 경우와 안된 경우가 나뉘는 것을 알 수 있음. 이걸 아는게 중요한 이유는 이를 통해서 dockerfile을 최적화할 수 있기 때문임.
앞 부분 instruction 이 수정되면 뒷부분은 수정되지 않았더라도 다시 이미지 레이어를 만들어 줘야함. 그렇기 때문에 잘 바뀌지 않는 instruction을 앞으로 빼고 자주 바뀌는걸 뒤로 넣어주면 같은 명령어라도 훨씬 빠르고 가볍게 이미지를 빌드할 수 있음. 위의 Dockerfile을 최적화해보면 다음과 같음

```docker
FROM diamol/node

CMD ["node", "web-ping/app.js"]

ENV TARGET="www.naver.com"\
		[key]="[value]"\
		[key2]="[value2]"

WORKDIR /web-ping

COPY app.js .
```

### 연습세션

Dockerfile을 활용하면 자동화된 이미지 빌드가 가능하지만, 상황에 따라 직접 이미지를 만들어야하는 경우가 있음. 예를 들어 컨테이너 안에 직접 들어가서 파일을 수정한다음에 뭔가를 하고 이미지를 배포해야한다면?
이런 상황을 대비해서 수동으로 이미지를 빌드해보는 방법을 연습했음.

필요한 개념은 아래와 같음

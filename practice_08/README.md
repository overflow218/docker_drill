# 8강. 헬스 체크를 지원하는 도커 이미지 빌드하기

지난 시간에 도커 컴포즈를 배우며 컨테이너가 이상 상태에 걸렸는지 체크하고 이를 다시 시작해주는 기능의 필요성을 느꼈음. 이번 시간에는 헬스 체크를 통해 컨테이너가 올바른 상태인지 체크하는 방법을 배워볼거임. 여기에 더해서 의존관계가 있는 컨테이너의 경우 디펜던시 체크를 통해 의존성이 잘 확보되었을때만 실행하고 그렇지 않을때는 리스타트하도록 하는 방법을 살펴볼거임

### 헬스 체크를 지원하는 도커 이미지 빌드하기

```docker
ENTRYPOINT ["dotnet", "/app/Numbers.Api.dll"]
HEALTHCHECK CMD curl --fail http://localhost/health

# 컨테이너 상태 확인하기
# 자세히 살펴보는 방법
docker inspect [container id/ name]
# 대충 보는방법
docker ps -a 
```

특정 이미지를 위한 도커파일의 일부임. 보면 healthcheck 부분에 헬스 체크를 위한 명령을 넣어준 것을 볼 수 있음. curl은 아주 기본적으로 헬스 체크를 위해 활용할 수 있는 방법중에 하나임. 다만 뒤에서 자세히 언급할거지만 빌드를 위한 도커 파일에는 꼭 필요한 명령만 들어가는게 원칙임. curl을 쓰는건 위험한 행동이라서 쉘에서 하는 거아니면 도커 파일에는 다른 방식으로 헬스체크 명령을 만들어줄거임

### 디펜던시 체크가 적용된 컨테이너 실행하기

```docker
CMD curl --fail http://numbers-api/rng && \
    dotnet Numbers.Web.dll
```

CMD 부분이 &&로 연결된 모습을 살펴볼 수 있음. 명령1 && 명령2 의 의미는 명령1을 실행하고 성공했을때만 명령2를 실행해라는 의미임. 유닉스, 윈도우 모두 동작함. —fail 옵션은 curl에서 상태코드를 컨테이너에 넘겨주도록 하는 옵션임. 

간단히 정리하면 헬스체크 → 컨테이너의 상태가 현재 정상적인지 (healthy)인지 체크하는 테스트
디펜던시 체크 → 디펜던시가 있는 컨테이너의 경우 디펜던시가 만족되는 상황인지를 체크하는 테스트
라고 이해하면 됨. 

### 애플리케이션 체크를 위한 커스텀 유틸리티 만들기

위에서도 언급했지만 curl은 아주 유용한 도구이지만, 실무에서는 보안 정책등의 이유로 사용할 수 없음. 
그래서 실제로는 체크를 위한 커스텀 도구를 만들어주어야함! 
커스텀 유틸리티는 장점이 아주 많음

- 애플리케이션과 같은 도구를 사용하므로 이미지에 추가적인 소프트웨어를 포함시킬 필요가 없음
- 반복문, 분기 등등 셸 스크립트에서는 표현하기 어려운 복잡한 체크로직을 활용할 수 있음
- 애플리케이션이랑 같은 설정을 활용해서 대상 URL을 여러 곳에서 반복 정으하거나 수정에서 누락시키는
일을 방지할 수 있음
- 애플리케이션과 같은 라이브러리 환경에서 데이터베이스 접속이나 인증서 파일의 유무 등등 컨테이너 실행전에 확인이 필요한 모든 사항을 검증할 수 있음

→ 요약하자면 내가 node로 애플리케이션 짰으면 헬스/디펜더시 체크를 위한 코드를 node로 짜서 테스트를 진행하면 된다는 의미임!

```docker
ENTRYPOINT ["dotnet", "Numbers.Api.dll"]
HEALTHCHECK CMD ["dotnet", "Utilities.HttpCheck.dll", "-u", "http://localhost/health"]
```

아래의 예시처럼 전에는 curl을 활용했다면 이제는 새롭게 추가해준 커스텀 유틸리티를 활용하는 모습을 확인할 수 있음

### 도커 컴포즈에 헬스 체크와 디펜던시 체크 정의하기

```docker
restart: on-failure
    environment:
      - RngApi__Url=http://numbers-api/rng
    ports:
      - "8088:80"
    healthcheck:
      test: ["CMD", "dotnet", "Utilities.HttpCheck.dll", "-t", "150"]
      interval: 5s
      timeout: 1s
      retries: 2
      start_period: 10s
    networks:
      - app-net
```

기본적으로 도커 이미지 만들때 헬스체크, 디펜던시 체크 관련 내용을 넣어줄 수 있음. 
근데 도커 컴포즈로 묶어서 실행할때 따로 헬스체크를 달아줄 수도 있음! 아마 여기에 헬스체크는 넣어줬는데
depends_on 을 활용해서 의존성 검사는 안하는지 질문이 생길 수 있음. 

### 헬스 체크와 디펜던시 체크로 복원력 있는 애플리케이션을 만들 수 있는 이유

위의 질문에 답을 하자면 일단 도커 컴포즈는 단일 서버 말고 클러스터 서버에서는 그 순서를 보장할 수 없다고 함. 실제 클러스터 서버에서 10개의 서버에 api이미지 20개 웹서버 이미지 50개가 돌아간다고 해보자. 
만약에 api 20개가 다 뜨고나서야 웹서버를 돌릴 수 있다고 순서를 제한해버리면 api 19개떴는데 하나만 문제있어서 안뜨는경우 전체 웹서버가 실행이 안됨. 근데 19개만 있어도 50개 다돌리는데는 충분하단 말이지. 

→ 요약하자면 실무에서는 저런 의존성을 고려해 실행 순서를 보장하려고 하기보다는 그냥 실행 시킨다음에 의존성 검사 실패하면 다시 시도하는 방식으로 구현한다고 함. 그렇게 해야 전체 서비스가 다운되는 시간없이 요청을 잘 처리할 수 있다고 합니다!

### 실습

실습 내용은 첨부된 자바 스크립트 이미지에 대해서 헬스체크랑 디펜던시 체크 걸어서 실행해보는 연습이었음~